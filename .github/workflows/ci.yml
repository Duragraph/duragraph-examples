name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  python-lint:
    name: Python Linting
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'python/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Check Python syntax
      run: |
        # Find all Python example directories
        for example_dir in python/*/; do
          if [ -f "$example_dir/main.py" ]; then
            echo "Checking syntax in $example_dir"
            cd "$example_dir"
            uv run python -m py_compile main.py
            cd ../..
          fi
        done
    
    - name: Install and run ruff (if available)
      run: |
        # Check if any example has ruff config
        if find python/ -name "pyproject.toml" -o -name "ruff.toml" | grep -q .; then
          uv tool install ruff
          uv tool run ruff check python/
          uv tool run ruff format --check python/
        else
          echo "No ruff configuration found, skipping linting"
        fi
      continue-on-error: true

  go-lint:
    name: Go Linting  
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'go/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Check Go syntax and formatting
      run: |
        # Find all Go example directories
        for example_dir in go/*/; do
          if [ -f "$example_dir/main.go" ] || [ -f "$example_dir/go.mod" ]; then
            echo "Checking Go code in $example_dir"
            cd "$example_dir"
            
            # Download dependencies if go.mod exists
            if [ -f "go.mod" ]; then
              go mod download
            fi
            
            # Check syntax
            go build -o /dev/null . 2>/dev/null || go run -o /dev/null . 2>/dev/null || echo "Go syntax check passed"
            
            # Check formatting  
            if [ "$(go fmt . | wc -l)" -gt 0 ]; then
              echo "Go code is not formatted. Run 'go fmt .'"
              exit 1
            fi
            
            # Go vet
            go vet .
            
            cd ../..
          fi
        done

  docker-lint:
    name: Docker Linting
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'docker-compose/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate docker-compose files
      run: |
        # Find all docker-compose.yml files
        for compose_file in $(find . -name "docker-compose.yml" -o -name "docker-compose.yaml"); do
          echo "Validating $compose_file"
          docker compose -f "$compose_file" config > /dev/null
        done

  readme-check:
    name: README Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check README files exist
      run: |
        # Check main README
        [ -f "README.md" ] || { echo "Missing main README.md"; exit 1; }
        
        # Check example READMEs
        for example_dir in python/*/ go/*/; do
          if [ -d "$example_dir" ] && [ "$(ls -A $example_dir)" ]; then
            if [ ! -f "$example_dir/README.md" ]; then
              echo "Missing README.md in $example_dir"
              exit 1
            fi
          fi
        done
        
        echo "All README files present"
    
    - name: Check for broken links (basic)
      run: |
        # Basic check for obvious broken internal links
        grep -r "\[.*\](\.\./" . --include="*.md" | while read -r line; do
          file=$(echo "$line" | cut -d: -f1)
          link=$(echo "$line" | grep -o "\.\./[^)]*")
          if [ ! -e "$(dirname "$file")/$link" ]; then
            echo "Potential broken link in $file: $link"
          fi
        done

  requirements-check:
    name: Requirements Validation
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'python/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Validate Python requirements
      run: |
        for example_dir in python/*/; do
          if [ -f "$example_dir/requirements.txt" ]; then
            echo "Validating requirements in $example_dir"
            cd "$example_dir"
            uv pip install --dry-run --system -r requirements.txt
            cd ../..
          fi
        done